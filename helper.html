<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é£è±¡è·¨å±åŠ©æ‰‹ - æ•™å®¤ç«¯</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0071fd;
            --primary-dark: #005bb5;
            --accent: #00c6ff;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --glass: rgba(255, 255, 255, 0.92);
            --shadow-lg: 0 20px 50px rgba(0,0,0,0.1);
            --shadow-card: 0 10px 30px rgba(0,0,0,0.05);
            --text-main: #1d1d1f;
            --text-sub: #86868b;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-gradient);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none; /* é˜²æ­¢é•¿æŒ‰é€‰ä¸­æ–‡æœ¬ï¼Œä¼˜åŒ–è§¦æ§ä½“éªŒ */
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .navbar {
            height: 80px;
            padding: 0 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            z-index: 100;
            flex-shrink: 0;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-img {
            height: 40px;
            object-fit: contain;
        }
        
        .app-title {
            font-size: 24px;
            font-weight: 900;
            background: linear-gradient(90deg, #0071fd, #00c6ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 1px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f0f2f5;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ccc; box-shadow: 0 0 0 2px rgba(255,255,255,0.5); }
        .status-badge.connected { background: rgba(7, 193, 96, 0.1); color: #07c160; }
        .status-badge.connected .status-dot { background: #07c160; box-shadow: 0 0 0 2px rgba(7, 193, 96, 0.3); animation: pulse 2s infinite; }

        /* ä¸»ä½“å¸ƒå±€ Grid */
        .main-layout {
            flex: 1;
            display: grid;
            grid-template-columns: 380px 1fr; /* å·¦ä¾§åŠ å®½ï¼Œæ›´é€‚åˆè§¦æ‘¸ */
            gap: 30px;
            padding: 30px;
            max-width: 1920px;
            margin: 0 auto;
            width: 100%;
            height: calc(100vh - 80px); /* å‡å»é¡¶éƒ¨é«˜åº¦ */
        }

        /* å·¦ä¾§è¾¹æ ï¼šæ§åˆ¶åŒº */
        .sidebar {
            background: var(--glass);
            border-radius: 24px;
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.5);
            height: 100%;
            overflow-y: auto;
        }

        .qr-container {
            background: white;
            padding: 15px;
            border-radius: 20px;
            box-shadow: var(--shadow-card);
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            width: 100%;
            max-width: 280px;
            /* å±…ä¸­äºŒç»´ç  */
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1/1;
        }
        
        /* é€‚é… qrcode.js ç”Ÿæˆçš„ canvas/img */
        .qr-container img, .qr-container canvas { 
            width: 100% !important; 
            height: auto !important; 
            display: block; 
            opacity: 0.5; 
            transition: opacity 0.5s; 
        }

        .instruction { margin-top: 10px; width: 100%; }
        .instruction h3 { margin: 0 0 10px 0; color: var(--text-main); font-size: 22px; }
        .instruction p { margin: 0; color: var(--text-sub); font-size: 16px; line-height: 1.6; }

        .action-area {
            margin-top: auto;
            width: 100%;
            padding-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* å¤§å±ä¸“ç”¨æŒ‰é’®ï¼šæ›´å¤§ã€æ›´æœ‰è´¨æ„Ÿ */
        .big-btn {
            width: 100%;
            height: 70px; /* åŠ é«˜ */
            border: none;
            border-radius: 18px;
            background: var(--primary);
            color: white;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(0, 113, 253, 0.3);
            transition: all 0.1s; /* å¿«é€Ÿå“åº” */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
        }
        /* æŒ‰å‹æ•ˆæœ */
        .big-btn:active { transform: scale(0.96); background: var(--primary-dark); }
        .big-btn.copied { background: #07c160; box-shadow: 0 10px 20px rgba(7, 193, 96, 0.3); }

        .secondary-btn {
            background: transparent;
            color: #999;
            font-size: 16px;
            padding: 15px;
            border: 2px dashed #ddd;
            border-radius: 16px;
            cursor: pointer;
        }
        .secondary-btn:active { background: #f0f0f0; border-color: #bbb; color: #666; }

        /* å³ä¾§ï¼šæ¶ˆæ¯ç€‘å¸ƒæµ */
        .content-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 100%;
            overflow: hidden;
            position: relative;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-sub);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .section-title::before { content: ''; width: 6px; height: 24px; background: var(--primary); border-radius: 3px; }

        /* æ¶ˆæ¯åˆ—è¡¨å®¹å™¨ */
        #msg-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px; /* å¢åŠ å†…è¾¹è·é˜²æ­¢é˜´å½±è¢«åˆ‡ */
            padding-bottom: 40px;
            /* é’ˆå¯¹è§¦æ‘¸å±ä¼˜åŒ–æ»šåŠ¨ä½“éªŒ */
            -webkit-overflow-scrolling: touch;
        }
        /* éšè—æ»šåŠ¨æ¡ï¼Œæ›´ç¾è§‚ï¼Œå¤§å±ç›´æ¥æ»‘ */
        #msg-container::-webkit-scrollbar { width: 0px; background: transparent; }

        /* æ¶ˆæ¯å¡ç‰‡ç»„ä»¶ - å¤§å±è§¦æ§ä¼˜åŒ–ç‰ˆ */
        .msg-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); /* é»˜è®¤è½»é˜´å½± */
            border: 2px solid transparent; /* é¢„ç•™è¾¹æ¡†ä½ç½® */
            position: relative;
            transition: all 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
            /* å…³é”®ï¼šæ•´ä½“ä½œä¸ºè§¦æ§ç›®æ ‡ */
        }
        
        /* è§¦æ‘¸/æ¿€æ´»æ€ï¼šæ¨¡æ‹Ÿç‰©ç†æŒ‰é”®ä¸‹æ²‰ */
        .msg-card:active {
            transform: scale(0.98);
            background: #f0f7ff;
            border-color: var(--primary);
        }

        .msg-card.latest {
            background: #f8fbff;
            border-color: rgba(0, 113, 253, 0.3);
            box-shadow: 0 8px 25px rgba(0, 113, 253, 0.1);
        }
        /* ç‚¹å‡»é«˜äº®åŠ¨ç”» */
        .msg-card.flash-active {
            animation: flashHighlight 0.4s ease-out;
            background: #e6f2ff !important;
            border-color: var(--primary) !important;
        }

        .msg-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            opacity: 0.7;
        }

        .msg-tag {
            font-size: 13px;
            font-weight: 800;
            color: var(--primary);
            background: rgba(0, 113, 253, 0.1);
            padding: 6px 12px;
            border-radius: 8px;
        }
        
        .msg-time { font-size: 14px; color: #999; font-family: monospace; }

        .msg-body {
            font-size: 32px; /* æ›´å¤§çš„å­—å·ï¼Œæ–¹ä¾¿è¿œçœ‹ */
            font-weight: 700;
            color: var(--text-main);
            line-height: 1.4;
            word-break: break-all;
        }

        /* å¤åˆ¶æç¤ºè§’æ ‡ (å¸¸é©»ï¼Œä¸å†hoveræ˜¾ç¤º) */
        .click-hint {
            position: absolute;
            right: 20px;
            bottom: 20px;
            color: var(--primary);
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            opacity: 0.6;
            pointer-events: none; /* ç©¿é€ */
        }
        .click-hint svg { width: 18px; height: 18px; fill: currentColor; }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #bbb;
            text-align: center;
            padding-bottom: 100px;
        }
        .empty-icon { font-size: 80px; margin-bottom: 20px; opacity: 0.3; }

        /* åŠ¨ç”» */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(7, 193, 96, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(7, 193, 96, 0); }
            100% { box-shadow: 0 0 0 0 rgba(7, 193, 96, 0); }
        }

        @keyframes flashHighlight {
            0% { transform: scale(0.98); background: var(--primary); color: white; }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); background: #e6f2ff; color: inherit; }
        }

        /* å“åº”å¼é€‚é… */
        @media (max-width: 900px) {
            .main-layout { grid-template-columns: 1fr; padding: 20px; display: flex; flex-direction: column; }
            .sidebar { flex-direction: row; justify-content: space-between; padding: 20px; text-align: left; height: auto; flex-shrink: 0; }
            .qr-container { margin: 0; width: 100px; padding: 5px; }
            .instruction { flex: 1; margin: 0 20px; }
            .action-area { width: auto; padding: 0; }
            .big-btn { width: 140px; height: 60px; font-size: 16px; }
            .content-area { margin-top: 10px; height: 100%; }
            .msg-body { font-size: 24px; }
            .secondary-btn { display: none; } /* ç§»åŠ¨ç«¯éšè—æ¸…ç©ºæŒ‰é’® */
        }
    </style>
</head>
<body>

    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="logo-area">
            <img src="https://static-nginx-online.fbcontent.cn/metis-lectio-web-static/static/media/logo.8461382d13d28a3fedc1.png" alt="Logo" class="logo-img">
            <div class="app-title">è·¨å±åŠ©æ‰‹</div>
        </div>
        <div class="status-badge" id="status-badge">
            <div class="status-dot"></div>
            <span id="status-text">è¿æ¥ä¸­...</span>
        </div>
    </nav>

    <!-- ä¸»å¸ƒå±€ -->
    <div class="main-layout">
        
        <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
        <aside class="sidebar">
            <div class="qr-container" id="qr-target">
                <!-- æœ¬åœ°ç”ŸæˆäºŒç»´ç  -->
            </div>
            <div class="instruction">
                <h3>æ‰‹æœºæ‰«ç è¾“å…¥</h3>
                <p>å¾®ä¿¡æ‰«ç  â€¢ è¯­éŸ³è½¬æ–‡å­—</p>
                <div style="margin-top:15px; font-size:14px; color:#999; background:#f5f7fa; padding:10px; border-radius:12px;">
                    æˆ¿é—´å·: <span id="room-id" style="font-family:monospace; font-weight:bold; color:#333; font-size:16px;">---</span>
                </div>
            </div>
            
            <div class="action-area">
                <button class="big-btn" id="copy-global-btn" onclick="copyLatest()">
                    <span>ğŸ“‹ å¤åˆ¶æœ€æ–°æ¶ˆæ¯</span>
                </button>
                <button class="secondary-btn" onclick="clearHistory()">
                    ğŸ—‘ï¸ æ¸…ç©ºå†å²è®°å½•
                </button>
            </div>
        </aside>

        <!-- å³ä¾§æ¶ˆæ¯æµ -->
        <main class="content-area">
            <div class="section-title">å®æ—¶æ¶ˆæ¯æµ (ç‚¹å‡»å¡ç‰‡å¤åˆ¶)</div>
            <div id="msg-container">
                <!-- ç©ºçŠ¶æ€ -->
                <div class="empty-state" id="empty-state">
                    <div class="empty-icon">ğŸ‘†</div>
                    <div style="font-size: 20px">æš‚æ— æ¶ˆæ¯</div>
                    <div style="font-size: 14px; margin-top: 10px">è¯·æ‰«æå·¦ä¾§äºŒç»´ç å‘é€å†…å®¹</div>
                </div>
            </div>
        </main>

    </div>

    <!-- éŸ³æ•ˆ -->
    <audio id="ding-sound" src="https://static-nginx-online.fbcontent.cn/metis-lectio-web-static/static/media/btn-click.4738a7907a16787e41ca.mp3"></audio>

    <script>
        /* ================= é…ç½® ================= */
        // âš ï¸ è¯·ç¡®ä¿æ­¤å¤„æ˜¯æ‚¨çœŸå®çš„ mobile.html éƒ¨ç½²åœ°å€
        const MOBILE_URL = "https://xiaolu-ai.github.io/wailiantalk/mobile.html";
        const MQTT_BROKER = "broker.emqx.io";
        const MQTT_PORT = 8084;
        /* ======================================= */

        const state = {
            client: null,
            roomId: 'fx_' + Math.random().toString(36).substr(2, 6).toUpperCase(),
            lastMsg: ''
        };

        // UI å¼•ç”¨
        const els = {
            badge: document.getElementById('status-badge'),
            statusText: document.getElementById('status-text'),
            qrTarget: document.getElementById('qr-target'),
            container: document.getElementById('msg-container'),
            empty: document.getElementById('empty-state'),
            globalBtn: document.getElementById('copy-global-btn'),
            roomLabel: document.getElementById('room-id'),
            audio: document.getElementById('ding-sound')
        };

        // åˆå§‹åŒ–
        function init() {
            // æ˜¾ç¤ºæˆ¿é—´å·
            els.roomLabel.innerText = state.roomId;

            // 1. æœ¬åœ°ç”ŸæˆäºŒç»´ç  (æ— ç½‘ç»œä¾èµ–)
            const link = `${MOBILE_URL}?room=${state.roomId}&mqtt=1`;
            els.qrTarget.innerHTML = ''; // æ¸…ç©º
            new QRCode(els.qrTarget, {
                text: link,
                width: 256,
                height: 256,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
            
            // 2. è¿æ¥ MQTT
            connectMQTT();
        }

        function connectMQTT() {
            const clientId = "screen_" + state.roomId + "_" + Date.now();
            state.client = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, clientId);

            state.client.onConnectionLost = (obj) => {
                console.log("è¿æ¥æ–­å¼€:", obj.errorMessage);
                updateStatus('error', 'è¿æ¥æ–­å¼€');
                setTimeout(connectMQTT, 2000);
            };

            state.client.onMessageArrived = (msg) => {
                const text = msg.payloadString;
                addMessageCard(text);
            };

            state.client.connect({
                useSSL: true,
                keepAliveInterval: 30,
                onSuccess: () => {
                    updateStatus('success', 'äº‘ç«¯å·²è¿æ¥');
                    // äºŒç»´ç æ·¡å…¥æ•ˆæœ
                    const qrCanvas = els.qrTarget.querySelector('canvas') || els.qrTarget.querySelector('img');
                    if(qrCanvas) qrCanvas.style.opacity = '1';
                    
                    state.client.subscribe("fx_channel/" + state.roomId);
                },
                onFailure: (e) => {
                    updateStatus('error', 'è¿æ¥å¤±è´¥');
                    setTimeout(connectMQTT, 5000);
                }
            });
        }

        function addMessageCard(text) {
            state.lastMsg = text;
            els.audio.play().catch(()=>{});

            // ç§»é™¤ç©ºçŠ¶æ€
            if(els.empty) els.empty.style.display = 'none';

            // ç§»é™¤æ—§æ¶ˆæ¯çš„ latest æ ·å¼
            const oldLatest = document.querySelector('.msg-card.latest');
            if(oldLatest) oldLatest.classList.remove('latest');

            // åˆ›å»ºæ–°å¡ç‰‡
            const card = document.createElement('div');
            card.className = 'msg-card latest';
            // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼šå…¨å¡ç‰‡ç‚¹å‡»å¤åˆ¶
            card.onclick = function() { copyText(this, text); };
            
            const timeStr = new Date().toLocaleTimeString('zh-CN', {hour12:false});
            
            card.innerHTML = `
                <div class="msg-header">
                    <span class="msg-tag">NEW</span>
                    <span class="msg-time">${timeStr}</span>
                </div>
                <div class="msg-body">${escapeHtml(text)}</div>
                <div class="click-hint">
                    <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                    ç‚¹æ­¤å¤åˆ¶
                </div>
            `;

            // æ’å…¥åˆ°æœ€å‰é¢
            els.container.insertBefore(card, els.container.firstChild);

            // è‡ªåŠ¨å¤åˆ¶
            copyLatest(true);
        }

        function copyLatest(isAuto = false) {
            if(!state.lastMsg) return;
            // å¦‚æœæ˜¯è‡ªåŠ¨å¤åˆ¶ï¼Œæˆ‘ä»¬ä½¿ç”¨å…¨å±€æŒ‰é’®åšåé¦ˆ
            copyText(els.globalBtn, state.lastMsg, isAuto);
        }

        function copyText(element, text, isAuto = false) {
            navigator.clipboard.writeText(text).then(() => {
                // è§†è§‰åé¦ˆé€»è¾‘
                
                // 1. å¦‚æœæ˜¯ç‚¹å‡»å¡ç‰‡
                if (element.classList.contains('msg-card')) {
                    element.classList.add('flash-active');
                    const hint = element.querySelector('.click-hint');
                    if(hint) hint.innerHTML = 'âœ… å·²å¤åˆ¶';
                    
                    setTimeout(() => {
                        element.classList.remove('flash-active');
                        if(hint) hint.innerHTML = '<svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg> ç‚¹æ­¤å¤åˆ¶';
                    }, 800);
                } 
                // 2. å¦‚æœæ˜¯ç‚¹å‡»å…¨å±€æŒ‰é’®
                else {
                    const originalHTML = element.innerHTML;
                    element.innerHTML = '<span>âœ… å·²å¤åˆ¶æˆåŠŸ</span>';
                    element.classList.add('copied');
                    
                    if(!isAuto && navigator.vibrate) navigator.vibrate(50);

                    setTimeout(() => {
                        element.innerHTML = originalHTML;
                        element.classList.remove('copied');
                    }, 2000);
                }
            });
        }
        
        function clearHistory() {
            if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²æ¶ˆæ¯å—ï¼Ÿ')) {
                els.container.innerHTML = '';
                els.container.appendChild(els.empty);
                els.empty.style.display = 'flex';
                state.lastMsg = '';
            }
        }

        function updateStatus(type, text) {
            els.statusText.innerText = text;
            els.badge.className = 'status-badge'; // reset
            if(type === 'success') {
                els.badge.classList.add('connected');
            }
        }
        
        function escapeHtml(text) {
            if (!text) return text;
            return text.replace(/&/g, "&amp;")
                       .replace(/</g, "&lt;")
                       .replace(/>/g, "&gt;")
                       .replace(/"/g, "&quot;")
                       .replace(/'/g, "&#039;");
        }

        // å¯åŠ¨
        init();

    </script>
</body>
</html>
